<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>$ make now just</title><link rel="stylesheet" href="https://makenowjust.github.io/diary/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css"></head><body><header><h1><a href="https://makenowjust.github.io/diary/">$ make now just</a></h1></header><main><article><div class="article-header"><div class="time"><time pubdate datetime="2016-12-10T00:00:00+00:00">2016/12/10</time></div><h1>Crystalでシリアルポートに接続するライブラリを作った</h1></div><div class="article-content"><script async src="//cdn.embedly.com/widgets/platform.js"></script>
<script async src="//platform.twitter.com/widgets.js"></script>
<p>この記事は<a href="http://qiita.com/advent-calendar/2016/crystal">Crystal Advent Calendar 2016</a>の10日目の記事です。9日目はいなかったみたいです、残念。</p>
<h1>一行で</h1>
<p>Crystalでシリアルポートに接続するライブラリを作ったよ</p>
<p><a class="embedly-card" data-card-width="100%" data-card-controls="0" href="https://github.com/MakeNowJust/serialport">MakeNowJust/serialport: serial port library for Crystal</a></p>
<h1>本編</h1>
<h2>流れ</h2>
<p>本来ならボクはAdvent CalendarにCrystalで<code>memcached</code>を実装したものを記事にして投稿するつもりだったのですが、今一面白い記事が書けそうになかったので挫折しました。<code>Hash</code>の再実装とかしたくない‥‥。</p>
<p>そして今日になって、バイトの最中で微妙にやることがなくなって手持ち無沙汰にしていたところ社長にAdvent Calendarのことを話したら、会社のことを絡めるなら仕事中に書いてもいいと言われたのでどうにかして会社を絡めたネタを考えました。</p>
<p>で、どうしてシリアルポートなのかというと、ボクのバイトしている<a href="http://nyampass.com/">ニャンパス</a>ではIoTデバイスの開発もいくつか行なっています。その中にはいくつかシリアルポートを介してPCから信号を受け取り動作するデバイスや、その逆にシリアルポートでデータをPCへと送信デバイスがあります。Crystalを使ってそれらを制御できたら面白そうだったので、これをAdvent Calendarのテーマとしようと決めました。</p>
<p>それで少し調べてみたところ、<a href="https://github.com/marceloboeira/serial.cr">serial.cr</a>というlibserialportのバインディングらしき何かは見つけたのですが、どうもcrystal-libを適用する前のコードしか置かれていなくて全く使いものにならなそうなので、諦めて自作することにしたという次第です。というかこのMacBook Airにはlibserialportはインストールされていません。</p>
<h2>どんなライブラリを作るか考える</h2>
<p>Crystalには<a href="https://crystal-lang.org/api/0.20.1/IO/FileDescriptor.html"><code>IO::FileDescriptor</code></a>というクラスがあります。これはファイルデスクリプタをラップして<code>IO</code>クラスを実装したものです。つまり、ファイルデスクリプタがあれば<code>gets</code>メソッドや<code>&#x3C;&#x3C;</code>メソッドを使うことができるようになります。
（余談ですが、この<code>IO::FileDescriptor</code>クラスは<code>File</code>クラスや<code>Socket</code>クラスのスーパークラスです）</p>
<p><code>IO</code>クラスを実装しているので、<code>to_s</code>に渡したり<code>to_json</code>に渡したりと様々なことができるようになります。<code>IO</code>クラスは本当にCrystalの骨幹をなしています。<code>IO</code>クラスを制するものはCrystalを制すると言っても過言ではないでしょう。Crystalにおけるリバウンドであるというわけです。</p>
<p>また、C言語でシリアルポートを扱う際には<code>open</code>関数で<code>/dev</code>以下にあるデバイスファイルをオープンし、シリアルポート独特の設定をしたファイルデスクリプタに対して<code>write</code>や<code>read</code>をするみたいです。ちょうどいいですね。</p>
<p>というわけで、<code>IO::FileDescriptor</code>を継承し、<code>initialize</code>でファイルデスクリプタを設定して<code>super</code>に渡すようなクラスを作ることにしました。</p>
<h2><code>IO::FileDescriptor</code>を継承したクラスの作り方</h2>
<p>基本的にはこんな形になります。</p>
<pre><code class="hljs language-crystal"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HogeFile</span> &#x3C; <span class="hljs-title">IO::FileDescriptor</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span></span>(path : String)
    <span class="hljs-comment"># C言語の`open`関数を呼び出して、ファイルデスクリプタを得る</span>
    <span class="hljs-comment"># 引数の`path`に対して`check_no_null_byte`を呼び出して、C言語に渡しても問題のない文字列かチェックしている</span>
    fd = LibC.open(path.check_no_null_byte, <span class="hljs-symbol">LibC:</span>:O_RDWR)

    <span class="hljs-comment"># C言語の関数は失敗したからと言って例外を投げてくれないので、自前でチェックする必要がある</span>
    <span class="hljs-keyword">if</span> fd &#x3C; <span class="hljs-number">0</span>
      raise Error.new <span class="hljs-string">"cannot open '<span class="hljs-subst">#{path}</span>'"</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># （この辺で各クラス固有のファイルデスクリプタの設定をする）</span>

    <span class="hljs-comment"># `IO::FileDescriptor`をさっき得たファイルデスクリプタで初期化する</span>
    <span class="hljs-keyword">super</span> fd
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>事実、これだけのコードで<code>File</code>クラスのようにファイルを読み書きできるようになります。</p>
<p>そして、実際の<code>SerialPort</code>クラスはこうなりました。</p>
<pre><code class="hljs language-crystal"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SerialPort</span> &#x3C; <span class="hljs-title">IO::FileDescriptor</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span></span>(@path : String, baudrate : <span class="hljs-symbol">Termios:</span>:BaudRate, blocking = <span class="hljs-literal">false</span>)
    oflag = <span class="hljs-symbol">LibC:</span>:O_RDWR | <span class="hljs-symbol">LibC:</span>:O_NOCTTY | <span class="hljs-symbol">LibC:</span>:O_SYNC | <span class="hljs-symbol">LibC:</span>:O_CLOEXEC

    fd = LibC.open(path.check_no_null_byte, oflag)
    <span class="hljs-keyword">if</span> fd &#x3C; <span class="hljs-number">0</span>
      raise Errno.new(<span class="hljs-string">"Error opening serial port '<span class="hljs-subst">#{path}</span>'"</span>)
    <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">self</span>.sync = <span class="hljs-literal">true</span> <span class="hljs-comment"># no buffering</span>

    set_interface_attributes(fd, baudrate, blocking)
    <span class="hljs-keyword">super</span> fd, blocking
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>さきほどの<code>HogeFile</code>と比べると、<code>initialize</code>の引数に<code>baudrate</code>や<code>blocking</code>が増えていることが分かります。<code>baudrate</code>はシリアルポートのボードレートを指定するもので、<code>blocking</code>は<code>IO::FileDescriptor</code>にも元から存在する引数で、IOがブロックするかどうかを指定します。基本的には非同期の方がいいでしょう。</p>
<p>また、途中に<code>self.sync = true</code>という行がありますが、これは<code>IO::Buffered</code>を<code>include</code>しているので、バッファリングしないようにするためです。シリアルポートでバッファリングされるといつデータが送られるのか分からなくなってちょっと困ります。</p>
<p>最後の方に<code>set_interface_attributes</code>というメソッドの呼び出しがありますが、これが今回の実装のキモです。ここで<code>fd</code>をシリアルポート向けに設定します。</p>
<h2><code>set_interface_attributes</code>の実装</h2>
<p><code>set_interface_attributes</code>はC言語でシリアルポートに接続するコードを参考にして、次のようになりました。
（もちろんこのコードは実際には<code>class SerialPort &#x3C; IO::FileDescriptor</code>の中にあります）</p>
<pre><code class="hljs language-crystal">  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_interface_attributes</span></span>(fd, baudrate, blocking)
    <span class="hljs-keyword">if</span> LibC.tcgetattr(fd, <span class="hljs-keyword">out</span> mode) != <span class="hljs-number">0</span>
      raise Error.new(<span class="hljs-string">"initialize serial port: tcgetaddr"</span>)
    <span class="hljs-keyword">end</span>

    LibC.cfsetospeed(<span class="hljs-keyword">pointerof</span>(mode), baudrate)
    LibC.cfsetispeed(<span class="hljs-keyword">pointerof</span>(mode), baudrate)

    mode.c_cflag |= (<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">ControlMode:</span>:CLOCAL |
                     <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">ControlMode:</span>:CREAD).value <span class="hljs-comment"># ignore modem controls</span>
    mode.c_cflag &#x26;= ~<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">ControlMode:</span>:CSIZE.value
    mode.c_cflag |= <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">ControlMode:</span>:CS8.value     <span class="hljs-comment"># 8-bit characters</span>
    mode.c_cflag &#x26;= ~<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">ControlMode:</span>:PARENB.value <span class="hljs-comment"># no parity bit</span>
    mode.c_cflag &#x26;= ~<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">ControlMode:</span>:CSTOPB.value <span class="hljs-comment"># only need 1 stop bit</span>
    mode.c_cflag &#x26;= ~<span class="hljs-symbol">LibC:</span>:CRTSCTS                      <span class="hljs-comment"># no hardware flowcontrol</span>

    mode.c_iflag &#x26;= ~(<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:IGNBRK |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:BRKINT |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:PARMRK |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:ISTRIP |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:INLCR |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:IGNCR |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:ICRNL |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">InputMode:</span>:IXON).value
    mode.c_lflag &#x26;= ~(<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">LocalMode:</span>:ECHO |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">LocalMode:</span>:ECHONL |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">LocalMode:</span>:ICANON |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">LocalMode:</span>:ISIG |
                      <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">LocalMode:</span>:IEXTEN).value
    mode.c_oflag &#x26;= ~<span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">OutputMode:</span>:OPOST.value

    mode.c_cc[<span class="hljs-symbol">LibC:</span>:VMIN] = blocking ? <span class="hljs-number">1_u8</span> : <span class="hljs-number">0_u8</span>
    mode.c_cc[<span class="hljs-symbol">LibC:</span>:VTIME] = <span class="hljs-number">5_u8</span>

    <span class="hljs-keyword">if</span> LibC.tcsetattr(fd, <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">LineControl:</span>:TCSANOW, <span class="hljs-keyword">pointerof</span>(mode)) != <span class="hljs-number">0</span>
      raise Error.new(<span class="hljs-string">"initialize serial port: tcsetattr"</span>)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
</code></pre>
<p>特徴的なのは、冒頭で<code>LibC.tcgetattr(fd, out mode)</code>と<code>out</code>パラメーターを使って<code>mode</code>を受け取っていることでしょうか。</p>
<p>さて、ここで一つ問題が発生しました。Crystalは標準ライブラリに<code>termios.h</code>に対するバインディングをいくつか提供しているのですが、今回利用したい全てに対応しているというわけではありません。
しかし、幸いにもCrystalにはC言語の関数や定数を簡単に定義できる仕組みがあります。さくっと<code>libc.cr</code>というファイルを作って、足りない関数や定数を補うことにしました。
（定数の値や関数のプロトタイプ宣言などは、実際にヘッダファイルを見たり<code>man</code>ページを参考にして記述しました）</p>
<pre><code class="hljs language-crystal"><span class="hljs-class"><span class="hljs-keyword">lib</span> <span class="hljs-title">LibC</span></span>
  <span class="hljs-comment"># from fnctl.h</span>
  O_NOCTTY = <span class="hljs-number">0x20000</span>

  <span class="hljs-comment"># from termios.h</span>
  CCTS_OFLOW = <span class="hljs-number">0x00010000</span>
  CRTS_IFLOW = <span class="hljs-number">0x00020000</span>
  CDTR_IFLOW = <span class="hljs-number">0x00040000</span>
  CDSR_OFLOW = <span class="hljs-number">0x00080000</span>
  CCAR_OFLOW = <span class="hljs-number">0x00100000</span>
  CRTSCTS    = (CCTS_OFLOW | CRTS_IFLOW)

  VTIME = <span class="hljs-number">17</span>

  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cfsetospeed</span></span>(termios_p : Termios*, speed : SpeedT) : Int
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cfsetispeed</span></span>(termios_p : Termios*, speed : SpeedT) : Int

  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">tcdrain</span></span>(fd : Int) : Int
<span class="hljs-keyword">end</span>
</code></pre>
<p>さりげなく<code>initialize</code>の方にも本来は定義されていない定数があったことがバレてしまいましたね。</p>
<p>とりあえず、こんな風にしてCrystalでシリアルポートに接続するライブラリは完成しました、一応。</p>
<h2>それで、作ったもの。</h2>
<p>これです。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">なんなのか‥‥ <a href="https://t.co/n1j8mpsPU7">pic.twitter.com/n1j8mpsPU7</a></p>&mdash; さっき作った@3日目東R-13a (@make_now_just) <a href="https://twitter.com/make_now_just/status/807514728931041281">2016年12月10日</a></blockquote>
<p>なんなのか‥‥。</p>
<p>ちなみに、これを動かしたCrystalのスクリプトはこんな感じです。</p>
<pre><code class="hljs language-crystal"><span class="hljs-keyword">require</span> <span class="hljs-string">"./src/serialport"</span>

serial = SerialPort.new <span class="hljs-string">"/dev/なんとかかんとか"</span>, <span class="hljs-symbol">Termios:</span>:<span class="hljs-symbol">BaudRate:</span>:B9600

i = <span class="hljs-number">0</span>
loop <span class="hljs-keyword">do</span>
  serial &#x3C;&#x3C; <span class="hljs-string">"v <span class="hljs-subst">#{i}</span>"</span>
  i = (i + <span class="hljs-number">100</span>) % <span class="hljs-number">1024</span>
  sleep <span class="hljs-number">0.1</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>シリアルポートに「v 0-1023の数値」の形式で書き込むと数値に対応した位置までサーボモーターが動くというものが会社にあったので、それを動かしまくってみました。なんともシュールな光景になったと思います。このデバイスを作った人にはサーボモーターに負荷がかかるからやめろと言われました‥‥。ごめんなさい。</p>
<p>あと、シリアルポートを読み取る方のプログラムも書いたことには書いたのですが、センサーが不調だったようで上手く結果が取れなかったので非公開としておきます。</p>
<h2>今後の課題とか</h2>
<ul>
<li>Linuxや他の環境でも動くようにする（手元で動けばいいという気持ちで作ったから他の環境のことを考えていない。多分Cバインディング周りで、定数の値が違うからコケる）</li>
<li>テストを書く（どうやって書けばいいんすか‥‥）</li>
<li>シリアルポートに対してもっと細かく設定できるようにする（この辺は他のライブラリを参考にしたい）</li>
<li>というかもっとシリアルポートについて理解を深めろ（ぶっちゃけよく分かってない）</li>
</ul>
<p>誰かLinuxに移植したりテスト書いといたりしといてください。Pull Requestはいつでも待っています。</p>
<h1>最後に</h1>
<p>CrystalではC言語と簡単に連携できると言いますが、その例は大抵がC言語の関数を呼び出すところで終わってしまいます。しかし、本来ならばその先に、C言語の関数をCrystalらしく使えるようにする、という作業が残っているはずです。今回の記事では、その部分に少しフォーカスを当ててみたつもりです。</p>
<p>あと勢いでシリアルポートに繋ぐライブラリを作ってみましたが、これって使い途あるんでしょうか？　Crystalでシリアルポートにつなぎたい機会ってあります？　スクリプト言語の方がよくありません？　あ、でも組み込みで動かすときとかだと話は別なのかな‥‥。いや、Crystal組み込みで動かねえし‥‥。</p>
<p>とまあ使い途がよく分からなくなっているのですが、Crystalでシリアルポートに繋ぎたくなったらぜひ使ってみてください。</p>
<p>あと、もしもこの記事でニャンパスに興味を持った方がいたら、Halake（ニャンパスが運営しているコワーキングスペースです）に来たときに「MakeNowJustの記事を読んだよ」と言ってください。そうするとボクの給料が増えて日本経済を回すきっかけになる可能性があります。いや、ねーよ。</p>
<p>最後にどうしてボクがひたすらCrystalにコントリビュートしているのか書いたらかっこいいなとか思ったのですが、特に理由がありませんでした。強いて言えばpineさんがcrystal-jpとかやってるのについかっとなってやったとかそんな感じでしょうか（本当です）。完全にキレる若者ですね。若者ってこえー。</p>
<p>というわけでここまで読んでいただきありがとうございました。ありがとうございます。</p></div><div class="article-footer"><div class="author">written by <a href="https://github.com/MakeNowJust">TSUYUSATO "MakeNowJust" Kitsune</a></div></div><div id="disqus_thread"><script>//<![CDATA[
(function () {
  window.disqus_config = function () {
    var e = document.getElementById('disqus_thread')
    this.page.url = e.getAttribute('data-url')
    this.page.identifier = e.getAttribute('data-identifier')
  }

  var d = document, s = d.createElement('script'), t = d.head || d.body
  s.src = '//make-now-just.disqus.com/embed.js'
  s.setAttribute('data-timestamp', Date.now())
  t.appendChild(s)
})()
//]]></script></div></article></main><footer><small>&copy; 2016-2017 TSUYUSATO "MakeNowJust" Kitsune</small></footer></body></html>