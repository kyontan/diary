---
title: マスト丼の鯖を再構築した
---

# やったこと

## マスト丼の鯖を再構築した

マスト丼の鯖はConohaのメモリ2GBのプランを使っているのだけど、本来なら50GBあるはずのSSDが20GBしか使えていない。これは元々20GBしかSSDに容量がないメモリ500MBのプランからディスクを移行したせいで起きた問題で、どうもConohaは対処する気がないっぽいので、いい加減鯖を再構築することにした。`docker-compose build`をする度に容量が無くならないか怯える暮らしは正直しんどい。

せっかくなのでストレージをConohaのオブジェクトストレージにしたりした。これはそんなに大変じゃなかった。強いて言えば`swift`コマンドのインストールが面倒で、Homebrewになかったので仕方なくPythonの`venv`を切って、そこに`swift`コマンドをインストールした。多分、言語の方のSwiftのコマンドと被るからHomebrewには追加されないのだと思う。

Conohaのオブジェクトストレージにするための設定は[この辺](https://gist.github.com/esetomo/7993076bf186aa116df3f97f919bc783)を参考にした。ありがたい。

鯖の再構築は18時くらいに始めて、22時くらいに終わったと思う。大半がmastodonで`rails assets:precompile`すると`Permission denied`になる謎のバグに費された気がする。これの原因は結局よく分からないけれど、`public/packs`を消すと上手く動いたりする。

以下やったことまとめ（覚えている限り時系列順）。

  - 元の鯖の`h2o`を落とす
  - 元の鯖から手元にバックアップを取る
  - 元の鯖のマスト丼のSQLダンプを取る
  - Mastodonのリポジトリのrebase
  - 新しくサーバーを立てる
  - `pacaur`のインストール
  - `docker-compose`, `h2o`, `certbot`, `mackerel-agent`のインストール
    * `mackerel-agent`のインストールは地味にしんどかった。(AURのビルドスクリプトが死んでるので)
  - `docker-compose`でマスト丼を起動
  - `h2o`の設定を元の鯖から持ってくる
  - DNSの設定を変更して新しい鯖を向くようにする
  - ここら辺で`rails assets:precompile`がおかしくなる。がんばる。
  - どうにか動くようになる
  - アイコンがおかしかったりしたのを修正
  - `eslint`をかける

ちなみにMastodonのバージョンを2.0.0まで上げるとカスタム絵文字が使えるようになる。すごい。

あとTODO。

  - 鯖をもうちょい真面目に設定する（セキュリティ周りがいい加減すぎる）
  - マスト丼のdailyタスクを回すための仕組みを整える

他にもやることあった気がする。

そんな感じです。

# 思うところ

個人的なタスクとして、

  - Apocrypha観たい
  - 月姫やりたい

というのがある。時間を作るぞ。
